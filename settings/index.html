<!doctype html>
<html>
	<head>
		<link rel="stylesheet" href="/manager/webserver/assets/css/font.awesome.css">
		<script type="text/javascript" src="/manager/webserver/assets/js/jquery.js"></script>
		<script type="text/javascript" src="/homey.js" data-origin="settings"></script>

		<script type="text/javascript">
			function onHomeyReady(Homey) {
				var saveButton = $('#saveButton');
				var logoutButton = $('#logoutButton');

				Homey.ready();

				var response = $('#response');
				var usernameEl = $('#username');
				var passwordEl = $('#password');
				var logoutEl = $('#logoutElement');
				var hasUsername = false;
				var hasPassword = false;

				Homey.get('username', function(err, username){
					if (err) {
						return console.error('Could not get username', err);
					}

					console.log('username: ', username);
					usernameEl.val(username);
					if (username.length > 0) {
						logoutEl.show();
					}
				});

				Homey.get('password', function(err, password){
					if (err) {
						return console.error('Could not get password', err);
					}

					console.log('password: ', password);
					passwordEl.val(password);
					if (password.length > 0) {
						logoutEl.show();
					}
				});

				saveButton.on('click', function() {
					var username = usernameEl.val();
					var password = passwordEl.val();

					Homey.api('POST', '/login/', {
							"username": username,
							"password": password
						}, function(err, result) {
							if (err) {
								return console.log(err);
							}

							if (result.success) {
								response.css({color: 'green'});
								response.html(__('settings.login_success'));
								logoutEl.show();
							} else {
								response.css({color: 'red'});
								response.html(__('settings.login_failure') + '<br/>' + result.error);
								Homey.unset('username');
								Homey.unset('password');
							}
					});
				});

				logoutButton.on('click', function() {
					var response = $('#response');

					Homey.api('POST', '/logout/', function(err, result) {
						if (err) {
							response.css({color: 'red'});
							response.html(__('settings.logout_failure') + '<br/>' + result.error);
						} else {
							response.css({color: 'green'});
							response.html(__('settings.logout_success'));

							usernameEl.val('');
							passwordEl.val('');
						}
					});
				});
			}
		</script>
	</head>
	<body>
		<h1 data-i18n="settings.title"></h1>
		<p id="introText" data-i18n="settings.intro"></p>

		<p id="response"></p>

		<fieldset>
			<legend data-i18n="settings.logintitle"></legend>
			<span id="response"></span>
	        <div class="field row">
	            <label for="username" data-i18n="settings.username"></label>
	            <input id="username" type="text" value=""/>
	        </div>
	        <div class="field row">
	            <label for="password" data-i18n="settings.password"></label>
	            <input id="password" type="password" value=""/>
	        </div>

           	<button id="saveButton" class="left" style="display:block" data-i18n="settings.save" ></button>
    	</fieldset>

    	<fieldset id="logoutElement" style="display: none;">
    		<legend data-i18n="settings.logouttitle"></legend>
    		<button id="logoutButton" class="left" style="display:block" data-i18n="settings.logout" ></button>
    	</fieldset>

	</body>
</html>