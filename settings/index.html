<!doctype html>
<html>

<head>
    <link rel="stylesheet" href="/manager/webserver/assets/css/font.awesome.css">
    <script type="text/javascript" src="/manager/webserver/assets/js/jquery.js"></script>
    <script type="text/javascript" src="/homey.js" data-origin="settings"></script>

    <script type="text/javascript">
        function onHomeyReady(Homey) {
            var saveButton = $('#saveButton');
            var logoutButton = $('#logoutButton');
            var preferencesButton = $('#savePreferencesButton');

            Homey.ready();

            var response = $('#response');
            var usernameEl = $('#username');
            var passwordEl = $('#password');
            var syncSpeedEl = $('#sync_speed');
            var logoutEl = $('#logoutElement');
            var hasUsername = false;
            var hasPassword = false;

            Homey.get('username', function (err, username) {
                if (err) return Homey.alert(err);

                console.log('username: ', username);
                usernameEl.val(username);
                if (username.length > 0) {
                    logoutEl.show();
                }
            });

            Homey.get('password', function (err, password) {
                if (err) return Homey.alert(err);

                console.log('password: ', password);
                passwordEl.val(password);
                if (password.length > 0) {
                    logoutEl.show();
                }
            });

            Homey.get('syncInterval', function (err, interval) {
                if (err) return Homey.alert(err);
                syncSpeedEl.val(interval);
            });

            saveButton.on('click', function () {
                var username = usernameEl.val();
                var password = passwordEl.val();

                Homey.api('POST', '/login/', {
                    "username": username,
                    "password": password
                }, function (err, result) {
                    if (err) return Homey.alert(err);

                    if (result.success) {
                        response.css({
                            color: 'green'
                        });
                        response.html(__('settings.login_success'));
                        logoutEl.show();
                    } else {
                        response.css({
                            color: 'red'
                        });
                        response.html(__('settings.login_failure') + '<br/>' + result.error);
                        Homey.unset('username');
                        Homey.unset('password');
                    }
                });
            });

            logoutButton.on('click', function () {
                var response = $('#response');

                Homey.api('POST', '/logout/', function (err, result) {
                    if (err) {
                        response.css({
                            color: 'red'
                        });
                        response.html(__('settings.logout_failure') + '<br/>' + err.message);
                    } else {
                        response.css({
                            color: 'green'
                        });
                        response.html(__('settings.logout_success'));

                        usernameEl.val('');
                        passwordEl.val('');
                    }
                });
            });

            preferencesButton.on('click', function () {
                Homey.set('syncInterval', syncSpeedEl.val(), function (err) {
                    if (err) return Homey.alert(err);
                });
            });

            doStuff();
        }
    </script>
</head>

<body>
    <!-- Tab links -->
    <div class="tab">
        <button class="tablinks" onclick="setPage(event, 'settings')" id="defaultOpen">Settings</button>
        <button class="tablinks" onclick="setPage(event, 'errorLog')">Error Log</button>
        <button class="tablinks" onclick="setPage(event, 'log')">Device Log</button>
        <button class="tablinks" onclick="setPage(event, 'stateLog')">State Log</button>
        <button class="tablinks" onclick="setPage(event, 'simulator')">Simulation Data</button>
   </div>

    <!-- SETTINGS PAGE -->
    <div id="settings" class="tabcontent">
        <fieldset>
            <h1 data-i18n="settings.title"></h1>
            <p id="introText" data-i18n="settings.intro"></p>

            <p id="response"></p>

            <fieldset>
                <legend data-i18n="settings.logintitle"></legend>
                <span id="response"></span>
                <div class="field row">
                    <label for="username" data-i18n="settings.username"></label>
                    <input id="username" type="text" value="" />
                </div>
                <div class="field row">
                    <label for="password" data-i18n="settings.password"></label>
                    <input id="password" type="password" value="" />
                </div>

                <button id="saveButton" class="left" style="display:block" data-i18n="settings.save"></button>
            </fieldset>

            <fieldset id="logoutElement" style="display: none;">
                <legend data-i18n="settings.logouttitle"></legend>
                <button id="logoutButton" class="left" style="display:block" data-i18n="settings.logout"></button>
            </fieldset>

            <fieldset id="preferences">
                <legend data-i18n="settings.preferences"></legend>
                <div class="field row">
                    <label for="sync_speed" data-i18n="settings.sync_speed"></label>
                    <input id="sync_speed" type="text" value="" />
                    &nbsp;<span data-i18n="settings.sync_tooltip"></span>
                </div>

                <button id="savePreferencesButton" class="left" style="display:block"
                    data-i18n="settings.save_preferences"></button>
            </fieldset>
        </fieldset>
    </div>

    <!-- ERROR LOG PAGE -->
    <div id="errorLog" class="tabcontent">
        <fieldset>
            <p>Shows error encountered.</p>
            <p><button id="clearErrorLog">Clear Log</button><button id="sendErrorLog">Send Log</button></p>
            <div class="field row">
                <textarea id="errorLogData"></textarea>
            </div>
        </fieldset>
    </div>

    <!-- DEVICE LOG PAGE -->
    <div id="log" class="tabcontent">
        <fieldset>
            <p>Use this if you have a device that is not supported.</p>
            <p>Set the Log Enable option and wait for the data to appear. Then send the log.</p>
            <p>Contact @Adrian_Rockall on the community forum to describe which device is not supported.</p>
            <p>No personal data is captured or sent so if you don't contact me I will not be able to respond.</p>
            <div class="field row">
                <label for="logEnabled">Log Enabled</label>
                <input id="logEnabled" type="checkbox" value="logEnabled" />
            </div>
            <p><button id="clearLog">Clear Log</button><button id="sendDeviceLog">Send Log</button></p>
            <div class="field row">
                <textarea id="diagLog"></textarea>
            </div>
        </fieldset>
    </div>

    <!--SIMULATION PAGE -->
    <div id="simulator" class="tabcontent">
        <fieldset>
            <h1>For debug use only</h1>
            <p><button id="useSim">Activate</button><button id="clearSim">Clear Sim</button></p>
            <div class="field row">
                <textarea id="simData"></textarea>
            </div>
        </fieldset>
    </div>

    <!--STATE LOG PAGE -->
    <div id="stateLog" class="tabcontent">
        <fieldset>
            <h1>Recorded state values</h1>
            <div class="field row">
                <label for="stateLogEnabled">Log Enabled</label>
                <input id="stateLogEnabled" type="checkbox" value="logEnabled" />
            </div>
            <div class="field row">
                <textarea id="stateLogData"></textarea>
            </div>
        </fieldset>
    </div>

    <script type="text/javascript">
        var errorLogElement = document.getElementById('errorLogData');
        var clearErrorLogElement = document.getElementById('clearErrorLog');
        var sendErrorLogElement = document.getElementById('sendErrorLog');
        var diagLogElement = document.getElementById('diagLog');
        var logEnabledElement = document.getElementById('logEnabled');
        var clearLogElement = document.getElementById('clearLog');
        var sendDeviceLogElement = document.getElementById('sendDeviceLog');

        var useSimElement = document.getElementById('useSim');
        var clearSimElement = document.getElementById('clearSim');
        var simDataElement = document.getElementById('simData');

        var stateLogElement = document.getElementById('stateLogData');
        var stateLogEnabledElement = document.getElementById('stateLogEnabled');

        function doStuff() {
            document.getElementById("defaultOpen").click();

            Homey.on('settings.set', function () {
                Homey.get('errorLog', function (err, errorLog) {
                    if (err) return Homey.alert(err);
                    errorLogElement.value = JSON.stringify(errorLog, null, 2);
                });
                Homey.get('diagLog', function (err, diagLog) {
                    if (err) return Homey.alert(err);
                    diagLogElement.value = JSON.stringify(diagLog, null, 2);
                });
                Homey.get('logEnabled', function (err, logEnabled) {
                    if (err) return Homey.alert(err);
                    logEnabledElement.checked = logEnabled;
                });
                Homey.get('stateLog', function (err, stateLog) {
                    if (err) return Homey.alert(err);
                    stateLogElement.value = stateLog;
                });
            });

            clearErrorLogElement.addEventListener('click', function (e) {
                Homey.set('errorLog', "", function (err) {
                    if (err) return Homey.alert(err);
                });
                errorLogElement.value = "";
            });

            logEnabledElement.addEventListener('click', function (e) {
                Homey.set('logEnabled', logEnabledElement.checked, function (err) {
                    if (err) return Homey.alert(err);
                });
            });

            clearLogElement.addEventListener('click', function (e) {
                Homey.set('diagLog', "", function (err) {
                    if (err) return Homey.alert(err);
                });
                diagLogElement.value = "";
            });

            sendDeviceLogElement.addEventListener('click', function (e) {
                Homey.confirm("Send the device log contents to the developer?", null, function (e, ok) {
                    if (ok) {
                        Homey.api('POST', '/SendDeviceLog/', {
                            notify: true
                        }, function (err, result) {
                            if (err) {
                                return Homey.alert(err);
                            }
                        });
                    }
                });
            });

            sendErrorLogElement.addEventListener('click', function (e) {
                Homey.confirm("Send the error log contents to the developer?", null, function (e, ok) {
                    if (ok) {
                        Homey.api('POST', '/SendErrorLog/', {
                            notify: true
                        }, function (err, result) {
                            if (err) {
                                return Homey.alert(err);
                            }
                        });
                    }
                });
            });

            useSimElement.addEventListener('click', function (e) {
                Homey.set('simData', JSON.parse(simDataElement.value), function (err) {
                    if (err) {
                        return Homey.alert(err);
                    } else {
                        return Homey.alert("Simulator On");
                    }
                });
            });

            clearSimElement.addEventListener('click', function (e) {
                Homey.set('simData', "", function (err) {
                    if (err) {
                        return Homey.alert(err);
                    } else {
                        return Homey.alert("Simulator Off");
                    }
                });
            });

            stateLogEnabledElement.addEventListener('click', function (e) {
                Homey.set('stateLogEnabled', stateLogEnabledElement.checked, function (err) {
                    if (err) return Homey.alert(err);
                });
            });
        };

        function setPage(evt, tabPage) {
            var i, tabcontent, tablinks;

            // Get all elements with class="tabcontent" and hide them
            tabcontent = document.getElementsByClassName("tabcontent");
            for (i = 0; i < tabcontent.length; i++) {
                tabcontent[i].style.display = "none";
            }

            // Get all elements with class="tablinks" and remove the class "active"
            tablinks = document.getElementsByClassName("tablinks");
            for (i = 0; i < tablinks.length; i++) {
                tablinks[i].className = tablinks[i].className.replace(" active", "");
            }

            // Show the current tab, and add an "active" class to the button that opened the tab
            document.getElementById(tabPage).style.display = "block";
            evt.currentTarget.className += " active";

            if (tabPage == 'errorLog') {
                // Refresh the log data
                Homey.get('errorLog', function (err, errorLog) {
                    if (err) return Homey.alert(err);
                    errorLogElement.value = errorLog ? JSON.stringify(errorLog, null, 2) : "";
                });

                // Make the log text area fill the page
                errorLogElement.setAttribute('cols', errorLogElement.parentElement.clientWidth / 8);
                errorLogElement.style.height = (window.innerHeight - errorLogElement.offsetTop - 20) + 'px';
            }

            if (tabPage == 'log') {
                // Refresh the log data
                Homey.get('logEnabled', function (err, logEnabled) {
                    if (err) return Homey.alert(err);
                    logEnabledElement.checked = logEnabled;
                });

                Homey.get('diagLog', function (err, diagLog) {
                    if (err) return Homey.alert(err);
                    diagLogElement.value = diagLog ? JSON.stringify(diagLog, null, 2) : "";
                });

                // Make the log text area fill the page
                diagLogElement.setAttribute('cols', diagLogElement.parentElement.clientWidth / 8);
                diagLogElement.style.height = (window.innerHeight - diagLogElement.offsetTop - 20) + 'px';
            }

            if (tabPage == 'simulator') {
                Homey.get('simData', function (err, simData) {
                    if (err) return Homey.alert(err);
                    simDataElement.value = simData ? JSON.stringify(simData, null, 2) : "";
                });

                // Make the simulator text box fill the page
                simDataElement.setAttribute('cols', simDataElement.parentElement.clientWidth / 8);
                simDataElement.style.height = (window.innerHeight - simDataElement.offsetTop - 20) + 'px';
            }

            if (tabPage == 'stateLog') {
                Homey.get('stateLog', function (err, stateLogData) {
                    if (err) return Homey.alert(err);
                    stateLogElement.checked = stateLogData;
                });

                // Make the simulator text box fill the page
                stateLogElement.setAttribute('cols', stateLogElement.parentElement.clientWidth / 8);
                stateLogElement.style.height = (window.innerHeight - stateLogElement.offsetTop - 20) + 'px';
            }
        };
    </script>
</body>

</html>